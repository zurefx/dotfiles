#!/bin/bash
# Author: g3k

MUSIC_DIR="$HOME/.config/music"
PLAYER="mpv"
CYAN="\e[36m"
RESET="\e[0m"
BOLD="\e[1m"
NOTIFY_ID=6666
SHUFFLE_FILE="/tmp/music_shuffle.txt"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# AnimaciÃ³n
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loading() {
  local msg="$1"
  echo -ne "${CYAN}${msg}${RESET}"
  for c in '.' '..' '...'; do
    echo -ne "\r${CYAN}${msg}${c}${RESET}"
    sleep 0.3
  done
  echo -e "\r${CYAN}${msg}... listo!${RESET}"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# NotificaciÃ³n (sin imagen)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
notify_cyan() {
  local title="$1"
  local message="$2"
  dunstify -r "$NOTIFY_ID" -u normal -t 3000 -h string:x-dunst-stack-tag:music "$title" "$message"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Validar carpeta y archivos
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
validate_music_dir() {
  if [ ! -d "$MUSIC_DIR" ]; then
    echo -e "${CYAN}âš  Carpeta no encontrada:${RESET} $MUSIC_DIR"
    notify_cyan "Music Player" "âš  Carpeta no encontrada en $MUSIC_DIR"
    exit 1
  fi

  local mp3_count
  mp3_count=$(find "$MUSIC_DIR" -maxdepth 1 -type f -iname "*.mp3" | wc -l)
  if [ "$mp3_count" -eq 0 ]; then
    echo -e "${CYAN}âš  No hay archivos MP3 en:${RESET} $MUSIC_DIR"
    notify_cyan "Music Player" "âš  No se encontraron archivos MP3"
    exit 1
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Verificar si mpv estÃ¡ activo (solo nuestra mÃºsica)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
is_playing() {
  pgrep -f "mpv.*$MUSIC_DIR" >/dev/null
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Generar lista aleatoria sin repeticiÃ³n
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
generate_shuffle() {
  find "$MUSIC_DIR" -maxdepth 1 -type f -iname "*.mp3" | sort -R > "$SHUFFLE_FILE"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ReproducciÃ³n secuencial aleatoria
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
play_random_no_repeat() {
  echo -e "${CYAN}ðŸŽµ Generando lista aleatoria sin repeticiÃ³n...${RESET}"
  generate_shuffle

  while [ -f "$SHUFFLE_FILE" ]; do
    local total=$(wc -l < "$SHUFFLE_FILE")
    local count=0
    while IFS= read -r track; do
      [ ! -f "$SHUFFLE_FILE" ] && break 2  # si se borra el archivo, sal del bucle principal
      [ -z "$track" ] && continue
      count=$((count + 1))
      local base=$(basename "$track")
      echo -e "${CYAN}â™ª [$count/$total] Reproduciendo:${RESET} $base"
      notify_cyan "ðŸŽ¶ Reproduciendo ($count/$total)" "$base"
      "$PLAYER" --really-quiet --no-video --loop-file=no "$track"
    done < "$SHUFFLE_FILE"

    echo -e "${CYAN}ðŸ” Lista completada â€” remezclando...${RESET}"
    generate_shuffle
  done
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Detener mpv correctamente (solo mÃºsica del playlist)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
stop_music() {
  echo -e "${CYAN}ðŸŽ¶ Deteniendo mÃºsica...${RESET}"

  # Eliminar archivo de control para romper el bucle
  rm -f "$SHUFFLE_FILE"

  # Matar procesos mpv que estÃ©n reproduciendo desde la carpeta de mÃºsica
  pkill -f "mpv.*$MUSIC_DIR"

  sleep 1

  # Verificar si aÃºn queda algo activo
  if ! is_playing; then
    echo -e "${CYAN}âœ… MÃºsica detenida correctamente.${RESET}"
    notify_cyan "Music Player" "MÃºsica detenida correctamente ðŸŽµ"
  else
    echo -e "${CYAN}âœ– No se pudo detener toda la mÃºsica.${RESET}"
    notify_cyan "Music Player" "No se pudo detener completamente âš "
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MAIN
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clear
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${CYAN}â•‘        MUSIC PLAYLIST MANAGER ðŸŽµ             â•‘${RESET}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo

validate_music_dir

if is_playing; then
  echo -e "${CYAN}ðŸŽ¶ ReproducciÃ³n activa â€” deteniendo...${RESET}"
  loading "Deteniendo mÃºsica"
  stop_music
else
  echo -e "${CYAN}ðŸŽ§ Iniciando playlist aleatoria sin repeticiÃ³n...${RESET}"
  loading "Cargando MPV"
  
  (
    play_random_no_repeat
  ) >/dev/null 2>&1 &

  sleep 1
  if is_playing; then
    echo -e "${CYAN}âœ… Playlist iniciada correctamente.${RESET}"
    notify_cyan "Music Player" "Playlist aleatoria en reproducciÃ³n ðŸŽ¶"
  else
    echo -e "${CYAN}âœ– Error al iniciar playlist.${RESET}"
    notify_cyan "Music Player" "No se pudo iniciar la playlist âš "
  fi
fi
