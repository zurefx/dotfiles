#!/bin/bash
# Author: g3k

SRC_DIR="$HOME/.config/bspwm/scripts/src"
LOGFILE="$HOME/.vpn.log"
ICON="$HOME/.config/bspwm/scripts/images/htb.png"
TIMEOUT=15

notify() { dunstify -u "$1" -r 9999 -i "$ICON" "$2" "$3"; }

is_connected() {
    pgrep -f "openvpn --config" >/dev/null && return 0
    ip a | grep -q "tun0" && return 0
    return 1
}

disconnect_vpn() {
    echo "Disconnecting VPN..."
    sudo pkill -f openvpn >/dev/null 2>&1
    sudo ip link delete tun0 >/dev/null 2>&1
    notify normal "VPN" "Disconnected"
    echo "✅ Disconnected"
    exit 0
}

validate_ovpn() {
    local f="$1"
    [ -r "$f" ] || return 1
    [ "$(stat -c%s "$f" 2>/dev/null || echo 0)" -gt 50 ] || return 2
    local c=0
    grep -qi '^ *client' "$f" && ((c++))
    grep -qi '^ *remote' "$f" && ((c++))
    grep -qi '^ *dev' "$f" && ((c++))
    grep -qi '^ *proto' "$f" && ((c++))
    [ "$c" -ge 2 ] || return 3
}

connect_vpn() {
    sudo pkill -f openvpn >/dev/null 2>&1
    : > "$LOGFILE"
    sudo openvpn --config "$1" --daemon --log "$LOGFILE" 2>>"$LOGFILE"
}

wait_init() {
    local t=0
    while [ $t -lt "$TIMEOUT" ]; do
        grep -q "Initialization Sequence Completed" "$LOGFILE" && return 0
        grep -qiE "ERROR|Options error|Exiting" "$LOGFILE" && return 2
        ip a | grep -q "tun0" && return 0
        sleep 1; t=$((t+1))
    done
    return 1
}

# -------- toggle logic --------

if is_connected; then
    disconnect_vpn
fi

# not connected -> connect

[ -d "$SRC_DIR" ] || { echo "Dir not found"; notify critical "VPN" "Dir not found"; exit 1; }

shopt -s nullglob; VPNs=("$SRC_DIR"/*.ovpn); shopt -u nullglob
count=${#VPNs[@]}

[ $count -gt 0 ] || { echo "No .ovpn"; notify critical "VPN" "No .ovpn"; exit 1; }

if [ $count -eq 1 ]; then
    FILE="${VPNs[0]}"
    echo "Using default: $(basename "$FILE")"
else
    echo "VPN configs:"
    for i in "${!VPNs[@]}"; do echo "[$((i+1))] $(basename "${VPNs[$i]}")"; done
    read -p "Select: " n
    [[ "$n" =~ ^[0-9]+$ ]] && [ "$n" -ge 1 ] && [ "$n" -le $count ] \
        || { echo "Invalid"; notify critical "VPN" "Invalid selection"; exit 1; }
    FILE="${VPNs[$((n-1))]}"
fi

echo "Validating $(basename "$FILE")..."
validate_ovpn "$FILE" || { echo "Invalid .ovpn"; notify critical "VPN" "Bad config"; exit 1; }

echo "Connecting..."
connect_vpn "$FILE"; sleep 1

wait_init
case $? in
    0) echo "✅ Connected"; notify normal "VPN" "Connected"; exit 0;;
    1) echo "❌ Timeout"; notify critical "VPN" "Timeout"; exit 1;;
    2) echo "❌ Error"; notify critical "VPN" "Error in log"; exit 2;;
esac

echo "❌ Unknown"
notify critical "VPN" "Unknown error"
exit 3

